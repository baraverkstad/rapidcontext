
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="JsDoc" />
    <link rel="stylesheet" href="../css/style.css" type="text/css">
    <link rel="stylesheet" href="../css/doc.css" type="text/css">
    <link rel="stylesheet" href="../css/font-awesome-4.7.0.min.css" type="text/css">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../images/logotype-icon.ico">
    <link rel="icon" type="image/png" sizes="256x256" href="../images/logotype-icon-256x256.png">
    <link rel="apple-touch-icon" sizes="256x256" href="../images/logotype-icon-256x256.png">
    <title>RapidContext :: JavaScript API</title>
  </head>
  <body class="doc">

    <section class="header">
      <div class="center">
        <a href="https://www.rapidcontext.com/" class="logotype">
          <img src="../images/logotype.png" />
        </a>
        <div class="text">
          <a href="https://www.rapidcontext.com/">
            <span style="font-size: 3.6em;">RapidContext</span><br>
            <span style="font-size: 1.75em; color: #caf3ff;">Access &#183; Discovery &#183; Insight</span><br>
            <span style="font-size: 1.3em; letter-spacing: 0.34em; line-height: 1.8em;">www.rapidcontext.com</span>
          </a>
        </div>
      </div>
      <div class="menu">
        <a href="https://www.rapidcontext.com/doc/index.html">Docs</a>
        &bull; <a href="https://github.com/cederberg/rapidcontext/releases">Downloads</a>
        &bull; <a href="https://github.com/cederberg/rapidcontext">Project</a>
      </div>
    </section>

    <section class="content center">
      <ol class="breadcrumb">
        <li><a href="../index.html">Documentation</a></li>

        <li><a href="index.html">JavaScript API</a></li>
        <li class="active">RapidContext_App.js</li>

      </ol>

      <div class="jsdoc">
        <h1 class="classTitle">Source RapidContext_App.js</h1>




    <section>
        <article>
            <pre><code class="hljs language-js" data-highlighted="yes"><span id="line1" class="lineno">1</span><span class="hljs-comment">/*
<span id="line2" class="lineno">2</span> * RapidContext &lt;https://www.rapidcontext.com/&gt;
<span id="line3" class="lineno">3</span> * Copyright (c) 2007-2026 Per Cederberg. All rights reserved.
<span id="line4" class="lineno">4</span> *
<span id="line5" class="lineno">5</span> * This program is free software: you can redistribute it and/or
<span id="line6" class="lineno">6</span> * modify it under the terms of the BSD license.
<span id="line7" class="lineno">7</span> *
<span id="line8" class="lineno">8</span> * This program is distributed in the hope that it will be useful,
<span id="line9" class="lineno">9</span> * but WITHOUT ANY WARRANTY; without even the implied warranty of
<span id="line10" class="lineno">10</span> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
<span id="line11" class="lineno">11</span> *
<span id="line12" class="lineno">12</span> * See the RapidContext LICENSE for more details.
<span id="line13" class="lineno">13</span> */</span>
<span id="line14" class="lineno">14</span>
<span id="line15" class="lineno">15</span><span class="hljs-comment">/**
<span id="line16" class="lineno">16</span> * The base RapidContext namespace.
<span id="line17" class="lineno">17</span> * <span class="hljs-doctag">@namespace</span> <span class="hljs-variable">RapidContext</span>
<span id="line18" class="lineno">18</span> * <span class="hljs-doctag">@private</span>
<span id="line19" class="lineno">19</span> */</span>
<span id="line20" class="lineno">20</span><span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(<span class="hljs-title class_">RapidContext</span>) == <span class="hljs-string">&quot;undefined&quot;</span>) {
<span id="line21" class="lineno">21</span>    <span class="hljs-title class_">RapidContext</span> = {};
<span id="line22" class="lineno">22</span>}
<span id="line23" class="lineno">23</span>
<span id="line24" class="lineno">24</span><span class="hljs-comment">/**
<span id="line25" class="lineno">25</span> * Provides functions for application bootstrap and server communication.
<span id="line26" class="lineno">26</span> * <span class="hljs-doctag">@namespace</span> RapidContext.App
<span id="line27" class="lineno">27</span> */</span>
<span id="line28" class="lineno">28</span><span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>) == <span class="hljs-string">&quot;undefined&quot;</span>) {
<span id="line29" class="lineno">29</span>    <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span> = {};
<span id="line30" class="lineno">30</span>}
<span id="line31" class="lineno">31</span>
<span id="line32" class="lineno">32</span><span class="hljs-comment">/**
<span id="line33" class="lineno">33</span> * Initializes the platform, API:s and RapidContext UI. If an app
<span id="line34" class="lineno">34</span> * identifier is provided, the default platform UI will not be
<span id="line35" class="lineno">35</span> * created. Instead the app will be launched with the root document
<span id="line36" class="lineno">36</span> * as its UI container.
<span id="line37" class="lineno">37</span> *
<span id="line38" class="lineno">38</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [app] the app id to start
<span id="line39" class="lineno">39</span> *
<span id="line40" class="lineno">40</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a promise that will resolve when initialization has
<span id="line41" class="lineno">41</span> *         either completed or failed
<span id="line42" class="lineno">42</span> */</span>
<span id="line43" class="lineno">43</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) {
<span id="line44" class="lineno">44</span>    <span class="hljs-comment">// Initialize UI</span>
<span id="line45" class="lineno">45</span>    <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">context</span>(<span class="hljs-string">&quot;RapidContext.App.init()&quot;</span>);
<span id="line46" class="lineno">46</span>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;Initializing RapidContext&quot;</span>);
<span id="line47" class="lineno">47</span>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;&quot;</span>;
<span id="line48" class="lineno">48</span>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">append</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Widget</span>.<span class="hljs-title class_">Overlay</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Loading...&quot;</span> }));
<span id="line49" class="lineno">49</span>
<span id="line50" class="lineno">50</span>    <span class="hljs-comment">// Load platform data (into cache)</span>
<span id="line51" class="lineno">51</span>    <span class="hljs-keyword">const</span> cachedData = [
<span id="line52" class="lineno">52</span>        <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/status&quot;</span>),
<span id="line53" class="lineno">53</span>        <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/session/current&quot;</span>),
<span id="line54" class="lineno">54</span>        <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/app/list&quot;</span>)
<span id="line55" class="lineno">55</span>    ];
<span id="line56" class="lineno">56</span>
<span id="line57" class="lineno">57</span>    <span class="hljs-comment">// Launch app</span>
<span id="line58" class="lineno">58</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(cachedData)
<span id="line59" class="lineno">59</span>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
<span id="line60" class="lineno">60</span>            <span class="hljs-keyword">const</span> hourly = <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
<span id="line61" class="lineno">61</span>            <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/session/current&quot;</span>), hourly);
<span id="line62" class="lineno">62</span>            <span class="hljs-keyword">const</span> isStart = !app || app === <span class="hljs-string">&quot;start&quot;</span>;
<span id="line63" class="lineno">63</span>            <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">startApp</span>(app ?? <span class="hljs-string">&quot;start&quot;</span>)
<span id="line64" class="lineno">64</span>                .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">showError</span>(err)))
<span id="line65" class="lineno">65</span>                .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> isStart ? <span class="hljs-literal">null</span> : <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">startApp</span>(<span class="hljs-string">&quot;start&quot;</span>));
<span id="line66" class="lineno">66</span>        })
<span id="line67" class="lineno">67</span>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">showError</span>(err)))
<span id="line68" class="lineno">68</span>        .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">context</span>(<span class="hljs-literal">null</span>));
<span id="line69" class="lineno">69</span>};
<span id="line70" class="lineno">70</span>
<span id="line71" class="lineno">71</span><span class="hljs-comment">/**
<span id="line72" class="lineno">72</span> * Returns an object with status information about the platform and
<span id="line73" class="lineno">73</span> * currently loaded environment. The object returned is a copy of
<span id="line74" class="lineno">74</span> * the internal data structure and can be modified without affecting
<span id="line75" class="lineno">75</span> * the real data.
<span id="line76" class="lineno">76</span> *
<span id="line77" class="lineno">77</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Object</span>} the status data object
<span id="line78" class="lineno">78</span> */</span>
<span id="line79" class="lineno">79</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">status</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
<span id="line80" class="lineno">80</span>    <span class="hljs-keyword">return</span> { ...<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_Cache</span>.<span class="hljs-property">status</span> };
<span id="line81" class="lineno">81</span>};
<span id="line82" class="lineno">82</span>
<span id="line83" class="lineno">83</span><span class="hljs-comment">/**
<span id="line84" class="lineno">84</span> * Returns an object with information about the user. The object
<span id="line85" class="lineno">85</span> * returned is a copy of the internal data structure and can be
<span id="line86" class="lineno">86</span> * modified without affecting the real data.
<span id="line87" class="lineno">87</span> *
<span id="line88" class="lineno">88</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Object</span>} the user data object
<span id="line89" class="lineno">89</span> */</span>
<span id="line90" class="lineno">90</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">user</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
<span id="line91" class="lineno">91</span>    <span class="hljs-keyword">return</span> { ...<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_Cache</span>.<span class="hljs-property">user</span> };
<span id="line92" class="lineno">92</span>};
<span id="line93" class="lineno">93</span>
<span id="line94" class="lineno">94</span><span class="hljs-comment">/**
<span id="line95" class="lineno">95</span> * Returns an array with app launchers. The data returned is an
<span id="line96" class="lineno">96</span> * internal data structure and should not be modified.
<span id="line97" class="lineno">97</span> *
<span id="line98" class="lineno">98</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Array</span>} the loaded app launchers (read-only)
<span id="line99" class="lineno">99</span> */</span>
<span id="line100" class="lineno">100</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">apps</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
<span id="line101" class="lineno">101</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_Cache</span>.<span class="hljs-property">apps</span>);
<span id="line102" class="lineno">102</span>};
<span id="line103" class="lineno">103</span>
<span id="line104" class="lineno">104</span><span class="hljs-comment">/**
<span id="line105" class="lineno">105</span> * Returns an array with running app instances.
<span id="line106" class="lineno">106</span> *
<span id="line107" class="lineno">107</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Array</span>} the array of app instances
<span id="line108" class="lineno">108</span> */</span>
<span id="line109" class="lineno">109</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_instances</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
<span id="line110" class="lineno">110</span>    <span class="hljs-keyword">let</span> res = [];
<span id="line111" class="lineno">111</span>    <span class="hljs-keyword">const</span> apps = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">apps</span>();
<span id="line112" class="lineno">112</span>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; apps.<span class="hljs-property">length</span>; i++) {
<span id="line113" class="lineno">113</span>        res = res.<span class="hljs-title function_">concat</span>(apps[i].<span class="hljs-property">instances</span> ?? []);
<span id="line114" class="lineno">114</span>    }
<span id="line115" class="lineno">115</span>    <span class="hljs-keyword">return</span> res;
<span id="line116" class="lineno">116</span>};
<span id="line117" class="lineno">117</span>
<span id="line118" class="lineno">118</span><span class="hljs-comment">/**
<span id="line119" class="lineno">119</span> * Finds the app launcher from an app instance, class name or
<span id="line120" class="lineno">120</span> * launcher. In the last case, the matching cached launcher will be
<span id="line121" class="lineno">121</span> * returned.
<span id="line122" class="lineno">122</span> *
<span id="line123" class="lineno">123</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string|Object</span>} app the app id, instance, class name or
<span id="line124" class="lineno">124</span> *        launcher
<span id="line125" class="lineno">125</span> *
<span id="line126" class="lineno">126</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Object</span>} the read-only app launcher, or
<span id="line127" class="lineno">127</span> *         `null` if not found
<span id="line128" class="lineno">128</span> */</span>
<span id="line129" class="lineno">129</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">findApp</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) {
<span id="line130" class="lineno">130</span>    <span class="hljs-keyword">if</span> (app == <span class="hljs-literal">null</span>) {
<span id="line131" class="lineno">131</span>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span id="line132" class="lineno">132</span>    }
<span id="line133" class="lineno">133</span>    <span class="hljs-keyword">const</span> apps = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">apps</span>();
<span id="line134" class="lineno">134</span>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; apps.<span class="hljs-property">length</span>; i++) {
<span id="line135" class="lineno">135</span>        <span class="hljs-keyword">const</span> l = apps[i];
<span id="line136" class="lineno">136</span>        <span class="hljs-keyword">if</span> (l.<span class="hljs-property">id</span> == app || l.<span class="hljs-property">className</span> == app || l.<span class="hljs-property">id</span> == app.<span class="hljs-property">id</span>) {
<span id="line137" class="lineno">137</span>            <span class="hljs-keyword">return</span> l;
<span id="line138" class="lineno">138</span>        }
<span id="line139" class="lineno">139</span>    }
<span id="line140" class="lineno">140</span>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span id="line141" class="lineno">141</span>};
<span id="line142" class="lineno">142</span>
<span id="line143" class="lineno">143</span><span class="hljs-comment">/**
<span id="line144" class="lineno">144</span> * Creates and starts an app instance. Normally apps are started in the default
<span id="line145" class="lineno">145</span> * app tab container or in a provided widget DOM node. By specifying a newly
<span id="line146" class="lineno">146</span> * created window object as the parent container, apps can also be launched
<span id="line147" class="lineno">147</span> * into separate windows.
<span id="line148" class="lineno">148</span> *
<span id="line149" class="lineno">149</span> * Note that when a new window is used, the returned deferred will callback
<span id="line150" class="lineno">150</span> * immediately with a `null` app instance (normal app communication is not
<span id="line151" class="lineno">151</span> * possible cross-window).
<span id="line152" class="lineno">152</span> *
<span id="line153" class="lineno">153</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string|Object</span>} app the app id, class name or launcher
<span id="line154" class="lineno">154</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Widget/Window</span>} [container] the app container widget or
<span id="line155" class="lineno">155</span> *            window, defaults to create a new pane in the app tab
<span id="line156" class="lineno">156</span> *            container
<span id="line157" class="lineno">157</span> *
<span id="line158" class="lineno">158</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line159" class="lineno">159</span> *         resolve when the app has launched
<span id="line160" class="lineno">160</span> *
<span id="line161" class="lineno">161</span> * <span class="hljs-doctag">@example</span>
<span id="line162" class="lineno">162</span> * // Starts the help app in a new tab
<span id="line163" class="lineno">163</span> * RapidContext.App.startApp(&#x27;help&#x27;);
<span id="line164" class="lineno">164</span> *
<span id="line165" class="lineno">165</span> * // Starts the help app in a new window
<span id="line166" class="lineno">166</span> * RapidContext.App.startApp(&#x27;help&#x27;, window.open());
<span id="line167" class="lineno">167</span> */</span>
<span id="line168" class="lineno">168</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">startApp</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">app, container</span>) {
<span id="line169" class="lineno">169</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadResource</span>(<span class="hljs-params">res</span>) {
<span id="line170" class="lineno">170</span>        <span class="hljs-keyword">const</span> url = res.<span class="hljs-property">url</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(res.<span class="hljs-property">url</span>, <span class="hljs-variable language_">document</span>.<span class="hljs-property">baseURI</span>) : <span class="hljs-literal">null</span>;
<span id="line171" class="lineno">171</span>        <span class="hljs-keyword">const</span> jsonLoader = <span class="hljs-regexp">/\.json$/i</span>.<span class="hljs-title function_">test</span>(res.<span class="hljs-property">url</span>) ? <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadJSON</span> : <span class="hljs-literal">null</span>;
<span id="line172" class="lineno">172</span>        <span class="hljs-keyword">const</span> xmlLoader = <span class="hljs-regexp">/\.xml$/i</span>.<span class="hljs-title function_">test</span>(res.<span class="hljs-property">url</span>) ? <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadXML</span> : <span class="hljs-literal">null</span>;
<span id="line173" class="lineno">173</span>        <span class="hljs-keyword">switch</span> (res.<span class="hljs-property">type</span>) {
<span id="line174" class="lineno">174</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadScript</span>(res.<span class="hljs-property">url</span>);
<span id="line175" class="lineno">175</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;module&quot;</span>: <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">mod</span>) =&gt;</span> mod.<span class="hljs-property">default</span> ?? mod.<span class="hljs-property">create</span>);
<span id="line176" class="lineno">176</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;style&quot;</span>: <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadStyles</span>(res.<span class="hljs-property">url</span>);
<span id="line177" class="lineno">177</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ui&quot;</span>: <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadXML</span>(res.<span class="hljs-property">url</span>);
<span id="line178" class="lineno">178</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;data&quot;</span>: <span class="hljs-keyword">return</span> (jsonLoader ?? xmlLoader ?? <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadText</span>)(res.<span class="hljs-property">url</span>);
<span id="line179" class="lineno">179</span>        <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">url</span>);
<span id="line180" class="lineno">180</span>        }
<span id="line181" class="lineno">181</span>    }
<span id="line182" class="lineno">182</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">launcher, config</span>) {
<span id="line183" class="lineno">183</span>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Loading app/<span class="hljs-subst">${launcher.id}</span> resources`</span>, config.<span class="hljs-property">resources</span>);
<span id="line184" class="lineno">184</span>        launcher.<span class="hljs-property">resource</span> = {};
<span id="line185" class="lineno">185</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(config.<span class="hljs-property">resources</span>.<span class="hljs-title function_">map</span>(loadResource)).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">arr</span>) =&gt;</span> {
<span id="line186" class="lineno">186</span>            config.<span class="hljs-property">resources</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">res, i</span>) =&gt;</span> {
<span id="line187" class="lineno">187</span>                <span class="hljs-keyword">const</span> val = arr[i];
<span id="line188" class="lineno">188</span>                <span class="hljs-keyword">if</span> (res.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;module&quot;</span>) {
<span id="line189" class="lineno">189</span>                    launcher.<span class="hljs-property">creator</span> ??= val;
<span id="line190" class="lineno">190</span>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;ui&quot;</span>) {
<span id="line191" class="lineno">191</span>                    launcher.<span class="hljs-property">ui</span> = val;
<span id="line192" class="lineno">192</span>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (![<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;module&quot;</span>, <span class="hljs-string">&quot;style&quot;</span>, <span class="hljs-string">&quot;icon&quot;</span>, <span class="hljs-string">&quot;ui&quot;</span>].<span class="hljs-title function_">includes</span>(res.<span class="hljs-property">type</span>) &amp;&amp; val) {
<span id="line193" class="lineno">193</span>                    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">id</span>) {
<span id="line194" class="lineno">194</span>                        launcher.<span class="hljs-property">resource</span>[res.<span class="hljs-property">id</span>] = val;
<span id="line195" class="lineno">195</span>                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res.<span class="hljs-property">type</span>) {
<span id="line196" class="lineno">196</span>                        (launcher.<span class="hljs-property">resource</span>[res.<span class="hljs-property">type</span>] ??= []).<span class="hljs-title function_">push</span>(val);
<span id="line197" class="lineno">197</span>                    }
<span id="line198" class="lineno">198</span>                }
<span id="line199" class="lineno">199</span>            });
<span id="line200" class="lineno">200</span>            launcher.<span class="hljs-property">creator</span> ??= <span class="hljs-variable language_">window</span>[launcher.<span class="hljs-property">className</span>];
<span id="line201" class="lineno">201</span>            <span class="hljs-keyword">if</span> (launcher.<span class="hljs-property">creator</span> == <span class="hljs-literal">null</span>) {
<span id="line202" class="lineno">202</span>                <span class="hljs-keyword">const</span> msg = <span class="hljs-string">`App constructor <span class="hljs-subst">${launcher.className}</span> not defined`</span>;
<span id="line203" class="lineno">203</span>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg, launcher);
<span id="line204" class="lineno">204</span>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(msg);
<span id="line205" class="lineno">205</span>            }
<span id="line206" class="lineno">206</span>            <span class="hljs-keyword">return</span> config;
<span id="line207" class="lineno">207</span>        });
<span id="line208" class="lineno">208</span>    }
<span id="line209" class="lineno">209</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildUI</span>(<span class="hljs-params">parent, ids, ui</span>) {
<span id="line210" class="lineno">210</span>        <span class="hljs-keyword">const</span> root = ui.<span class="hljs-property">documentElement</span>;
<span id="line211" class="lineno">211</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; root.<span class="hljs-property">attributes</span>.<span class="hljs-property">length</span>; i++) {
<span id="line212" class="lineno">212</span>            <span class="hljs-keyword">const</span> attr = root.<span class="hljs-property">attributes</span>[i];
<span id="line213" class="lineno">213</span>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(parent.<span class="hljs-property">setAttrs</span>) === <span class="hljs-string">&quot;function&quot;</span>) {
<span id="line214" class="lineno">214</span>                parent.<span class="hljs-title function_">setAttrs</span>({ [attr.<span class="hljs-property">name</span>]: attr.<span class="hljs-property">value</span> });
<span id="line215" class="lineno">215</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (attr.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;class&quot;</span>) {
<span id="line216" class="lineno">216</span>                attr.<span class="hljs-property">value</span>.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\s+/g</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cls</span>) =&gt;</span> parent.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(cls));
<span id="line217" class="lineno">217</span>            } <span class="hljs-keyword">else</span> {
<span id="line218" class="lineno">218</span>                parent.<span class="hljs-title function_">setAttribute</span>(attr.<span class="hljs-property">name</span>, attr.<span class="hljs-property">value</span>);
<span id="line219" class="lineno">219</span>            }
<span id="line220" class="lineno">220</span>        }
<span id="line221" class="lineno">221</span>        <span class="hljs-keyword">const</span> arr = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(ui.<span class="hljs-property">documentElement</span>.<span class="hljs-property">childNodes</span>);
<span id="line222" class="lineno">222</span>        parent.<span class="hljs-title function_">append</span>(...arr.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">o</span>) =&gt;</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">create</span>(o)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>));
<span id="line223" class="lineno">223</span>        parent.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;[id]&quot;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> ids[el.<span class="hljs-property">attributes</span>.<span class="hljs-property">id</span>.<span class="hljs-property">value</span>] = el);
<span id="line224" class="lineno">224</span>    }
<span id="line225" class="lineno">225</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">launch</span>(<span class="hljs-params">launcher, ui</span>) {
<span id="line226" class="lineno">226</span>        <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">context</span>(<span class="hljs-string">`RapidContext.App.startApp(<span class="hljs-subst">${launcher.id}</span>)`</span>);
<span id="line227" class="lineno">227</span>        <span class="hljs-keyword">return</span> launcher.<span class="hljs-property">starter</span> = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/app/launch&quot;</span>, [launcher.<span class="hljs-property">id</span>])
<span id="line228" class="lineno">228</span>            .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> launcher.<span class="hljs-property">creator</span> ? config : <span class="hljs-title function_">load</span>(launcher, config))
<span id="line229" class="lineno">229</span>            .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
<span id="line230" class="lineno">230</span>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Starting app/<span class="hljs-subst">${launcher.id}</span>`</span>, launcher);
<span id="line231" class="lineno">231</span>                <span class="hljs-comment">/* eslint new-cap: &quot;off&quot; */</span>
<span id="line232" class="lineno">232</span>                <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> launcher.<span class="hljs-title function_">creator</span>();
<span id="line233" class="lineno">233</span>                <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(instance, {
<span id="line234" class="lineno">234</span>                    <span class="hljs-attr">id</span>: config.<span class="hljs-property">id</span>,
<span id="line235" class="lineno">235</span>                    <span class="hljs-attr">name</span>: config.<span class="hljs-property">name</span>,
<span id="line236" class="lineno">236</span>                    <span class="hljs-attr">resource</span>: launcher.<span class="hljs-property">resource</span>,
<span id="line237" class="lineno">237</span>                    <span class="hljs-attr">proc</span>: <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Procedure</span>.<span class="hljs-title function_">mapAll</span>(config.<span class="hljs-property">procedures</span>),
<span id="line238" class="lineno">238</span>                    <span class="hljs-attr">ui</span>: ui
<span id="line239" class="lineno">239</span>                });
<span id="line240" class="lineno">240</span>                launcher.<span class="hljs-property">instances</span>.<span class="hljs-title function_">push</span>(instance);
<span id="line241" class="lineno">241</span>                <span class="hljs-title class_">MochiKit</span>.<span class="hljs-property">Signal</span>.<span class="hljs-title function_">disconnectAll</span>(ui.<span class="hljs-property">root</span>, <span class="hljs-string">&quot;onclose&quot;</span>);
<span id="line242" class="lineno">242</span>                <span class="hljs-keyword">const</span> <span class="hljs-title function_">halt</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">stopApp</span>(instance);
<span id="line243" class="lineno">243</span>                <span class="hljs-title class_">MochiKit</span>.<span class="hljs-property">Signal</span>.<span class="hljs-title function_">connect</span>(ui.<span class="hljs-property">root</span>, <span class="hljs-string">&quot;onclose&quot;</span>, halt);
<span id="line244" class="lineno">244</span>                <span class="hljs-keyword">if</span> (launcher.<span class="hljs-property">ui</span> != <span class="hljs-literal">null</span>) {
<span id="line245" class="lineno">245</span>                    <span class="hljs-title function_">buildUI</span>(ui.<span class="hljs-property">root</span>, ui, launcher.<span class="hljs-property">ui</span>);
<span id="line246" class="lineno">246</span>                }
<span id="line247" class="lineno">247</span>                ui.<span class="hljs-property">overlay</span>.<span class="hljs-title function_">setAttrs</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Starting...&quot;</span> });
<span id="line248" class="lineno">248</span>                <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-number">0</span>) <span class="hljs-comment">// Wait for initial UI events</span>
<span id="line249" class="lineno">249</span>                    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callApp</span>(instance, <span class="hljs-string">&quot;start&quot;</span>));
<span id="line250" class="lineno">250</span>            })
<span id="line251" class="lineno">251</span>            .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
<span id="line252" class="lineno">252</span>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Failed to start app&quot;</span>, err);
<span id="line253" class="lineno">253</span>                <span class="hljs-title class_">MochiKit</span>.<span class="hljs-property">Signal</span>.<span class="hljs-title function_">disconnectAll</span>(ui.<span class="hljs-property">root</span>, <span class="hljs-string">&quot;onclose&quot;</span>);
<span id="line254" class="lineno">254</span>                <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;div&quot;</span>);
<span id="line255" class="lineno">255</span>                div.<span class="hljs-title function_">append</span>(<span class="hljs-title class_">String</span>(err));
<span id="line256" class="lineno">256</span>                ui.<span class="hljs-property">root</span>.<span class="hljs-title function_">append</span>(div);
<span id="line257" class="lineno">257</span>                <span class="hljs-keyword">if</span> (err.<span class="hljs-property">url</span>) {
<span id="line258" class="lineno">258</span>                    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;a&quot;</span>);
<span id="line259" class="lineno">259</span>                    link.<span class="hljs-property">className</span> = <span class="hljs-string">&quot;block mt-2&quot;</span>;
<span id="line260" class="lineno">260</span>                    link.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;href&quot;</span>, err.<span class="hljs-property">url</span>);
<span id="line261" class="lineno">261</span>                    link.<span class="hljs-title function_">append</span>(err.<span class="hljs-property">url</span>);
<span id="line262" class="lineno">262</span>                    ui.<span class="hljs-property">root</span>.<span class="hljs-title function_">append</span>(link);
<span id="line263" class="lineno">263</span>                }
<span id="line264" class="lineno">264</span>                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
<span id="line265" class="lineno">265</span>            })
<span id="line266" class="lineno">266</span>            .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
<span id="line267" class="lineno">267</span>                ui.<span class="hljs-property">overlay</span>.<span class="hljs-title function_">hide</span>();
<span id="line268" class="lineno">268</span>                ui.<span class="hljs-property">overlay</span>.<span class="hljs-title function_">setAttrs</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Working...&quot;</span> });
<span id="line269" class="lineno">269</span>                <span class="hljs-keyword">delete</span> launcher.<span class="hljs-property">starter</span>;
<span id="line270" class="lineno">270</span>                <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">context</span>(<span class="hljs-literal">null</span>);
<span id="line271" class="lineno">271</span>            });
<span id="line272" class="lineno">272</span>    }
<span id="line273" class="lineno">273</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">moveAppToStart</span>(<span class="hljs-params">instance, elems</span>) {
<span id="line274" class="lineno">274</span>        <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">findApp</span>(<span class="hljs-string">&quot;start&quot;</span>).<span class="hljs-property">instances</span>[<span class="hljs-number">0</span>];
<span id="line275" class="lineno">275</span>        <span class="hljs-keyword">const</span> opts = { <span class="hljs-attr">title</span>: instance.<span class="hljs-property">name</span>, <span class="hljs-attr">closeable</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">background</span>: <span class="hljs-literal">true</span> };
<span id="line276" class="lineno">276</span>        <span class="hljs-keyword">const</span> ui = start.<span class="hljs-title function_">initAppPane</span>(<span class="hljs-literal">null</span>, opts);
<span id="line277" class="lineno">277</span>        ui.<span class="hljs-property">root</span>.<span class="hljs-title function_">removeAll</span>();
<span id="line278" class="lineno">278</span>        ui.<span class="hljs-property">root</span>.<span class="hljs-title function_">addAll</span>(elems);
<span id="line279" class="lineno">279</span>    }
<span id="line280" class="lineno">280</span>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-title class_">Async</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
<span id="line281" class="lineno">281</span>        <span class="hljs-keyword">const</span> launcher = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">findApp</span>(app);
<span id="line282" class="lineno">282</span>        <span class="hljs-keyword">if</span> (launcher == <span class="hljs-literal">null</span>) {
<span id="line283" class="lineno">283</span>            <span class="hljs-keyword">const</span> msg = <span class="hljs-string">&quot;No matching app launcher found&quot;</span>;
<span id="line284" class="lineno">284</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg, app);
<span id="line285" class="lineno">285</span>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>([msg, <span class="hljs-string">&quot;: &quot;</span>, app].<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>));
<span id="line286" class="lineno">286</span>        }
<span id="line287" class="lineno">287</span>        <span class="hljs-keyword">const</span> instances = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">_instances</span>();
<span id="line288" class="lineno">288</span>        <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">findApp</span>(<span class="hljs-string">&quot;start&quot;</span>);
<span id="line289" class="lineno">289</span>        <span class="hljs-keyword">if</span> ($.<span class="hljs-title function_">isWindow</span>(container)) {
<span id="line290" class="lineno">290</span>            <span class="hljs-comment">// Launch app into separate window/tab</span>
<span id="line291" class="lineno">291</span>            <span class="hljs-keyword">const</span> href = <span class="hljs-string">`rapidcontext/app/<span class="hljs-subst">${launcher.id}</span>`</span>;
<span id="line292" class="lineno">292</span>            container.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(href, <span class="hljs-variable language_">document</span>.<span class="hljs-property">baseURI</span>).<span class="hljs-title function_">toString</span>();
<span id="line293" class="lineno">293</span>            <span class="hljs-title function_">resolve</span>();
<span id="line294" class="lineno">294</span>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start?.<span class="hljs-property">instances</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
<span id="line295" class="lineno">295</span>            <span class="hljs-comment">// Launch app into start app tab</span>
<span id="line296" class="lineno">296</span>            <span class="hljs-keyword">const</span> paneOpts = { <span class="hljs-attr">title</span>: launcher.<span class="hljs-property">name</span>, <span class="hljs-attr">closeable</span>: (launcher.<span class="hljs-property">launch</span> != <span class="hljs-string">&quot;once&quot;</span>) };
<span id="line297" class="lineno">297</span>            <span class="hljs-keyword">const</span> paneUi = start.<span class="hljs-property">instances</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">initAppPane</span>(container, paneOpts);
<span id="line298" class="lineno">298</span>            <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">launch</span>(launcher, paneUi));
<span id="line299" class="lineno">299</span>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (instances.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
<span id="line300" class="lineno">300</span>            <span class="hljs-comment">// Switch from single-app to multi-app mode</span>
<span id="line301" class="lineno">301</span>            <span class="hljs-keyword">const</span> elems = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">childNodes</span>);
<span id="line302" class="lineno">302</span>            <span class="hljs-keyword">const</span> overlay = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Widget</span>.<span class="hljs-title class_">Overlay</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Loading...&quot;</span> });
<span id="line303" class="lineno">303</span>            <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">insertBefore</span>(overlay, <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">childNodes</span>[<span class="hljs-number">0</span>]);
<span id="line304" class="lineno">304</span>            <span class="hljs-keyword">const</span> ui = { <span class="hljs-attr">root</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, <span class="hljs-attr">overlay</span>: overlay };
<span id="line305" class="lineno">305</span>            <span class="hljs-keyword">const</span> <span class="hljs-title function_">move</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">moveAppToStart</span>(instances[<span class="hljs-number">0</span>], elems);
<span id="line306" class="lineno">306</span>            <span class="hljs-keyword">const</span> <span class="hljs-title function_">recall</span> = (<span class="hljs-params"></span>) =&gt; (launcher.<span class="hljs-property">id</span> === <span class="hljs-string">&quot;start&quot;</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">startApp</span>(launcher.<span class="hljs-property">id</span>);
<span id="line307" class="lineno">307</span>            <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">launch</span>(start, ui).<span class="hljs-title function_">then</span>(move).<span class="hljs-title function_">then</span>(recall));
<span id="line308" class="lineno">308</span>        } <span class="hljs-keyword">else</span> {
<span id="line309" class="lineno">309</span>            <span class="hljs-comment">// Launch single-app mode</span>
<span id="line310" class="lineno">310</span>            <span class="hljs-keyword">const</span> ui = { <span class="hljs-attr">root</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, <span class="hljs-attr">overlay</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">childNodes</span>[<span class="hljs-number">0</span>] };
<span id="line311" class="lineno">311</span>            <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">launch</span>(launcher, ui));
<span id="line312" class="lineno">312</span>        }
<span id="line313" class="lineno">313</span>    });
<span id="line314" class="lineno">314</span>};
<span id="line315" class="lineno">315</span>
<span id="line316" class="lineno">316</span><span class="hljs-comment">/**
<span id="line317" class="lineno">317</span> * Stops an app instance. If only the class name or launcher is specified, the
<span id="line318" class="lineno">318</span> * most recently created instance will be stopped.
<span id="line319" class="lineno">319</span> *
<span id="line320" class="lineno">320</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string|Object</span>} app the app id, instance, class name or launcher
<span id="line321" class="lineno">321</span> *
<span id="line322" class="lineno">322</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line323" class="lineno">323</span> *         resolve when the app has been stopped
<span id="line324" class="lineno">324</span> */</span>
<span id="line325" class="lineno">325</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">stopApp</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) {
<span id="line326" class="lineno">326</span>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-title class_">Async</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
<span id="line327" class="lineno">327</span>        <span class="hljs-keyword">const</span> launcher = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">findApp</span>(app);
<span id="line328" class="lineno">328</span>        <span class="hljs-keyword">if</span> (!launcher || launcher.<span class="hljs-property">instances</span>.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {
<span id="line329" class="lineno">329</span>            <span class="hljs-keyword">const</span> msg = <span class="hljs-string">&quot;No running app instance found&quot;</span>;
<span id="line330" class="lineno">330</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg, app);
<span id="line331" class="lineno">331</span>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>([msg, <span class="hljs-string">&quot;: &quot;</span>, app].<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>));
<span id="line332" class="lineno">332</span>        }
<span id="line333" class="lineno">333</span>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Stopping app <span class="hljs-subst">${launcher.name}</span>`</span>);
<span id="line334" class="lineno">334</span>        <span class="hljs-keyword">const</span> pos = launcher.<span class="hljs-property">instances</span>.<span class="hljs-title function_">indexOf</span>(app);
<span id="line335" class="lineno">335</span>        <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) {
<span id="line336" class="lineno">336</span>            app = launcher.<span class="hljs-property">instances</span>.<span class="hljs-title function_">pop</span>();
<span id="line337" class="lineno">337</span>        } <span class="hljs-keyword">else</span> {
<span id="line338" class="lineno">338</span>            launcher.<span class="hljs-property">instances</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>);
<span id="line339" class="lineno">339</span>        }
<span id="line340" class="lineno">340</span>        app.<span class="hljs-title function_">stop</span>();
<span id="line341" class="lineno">341</span>        <span class="hljs-keyword">if</span> (app.<span class="hljs-property">ui</span>.<span class="hljs-property">root</span> != <span class="hljs-literal">null</span>) {
<span id="line342" class="lineno">342</span>            <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Widget</span>.<span class="hljs-title function_">destroyWidget</span>(app.<span class="hljs-property">ui</span>.<span class="hljs-property">root</span>);
<span id="line343" class="lineno">343</span>        }
<span id="line344" class="lineno">344</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> app.<span class="hljs-property">ui</span>) {
<span id="line345" class="lineno">345</span>            <span class="hljs-keyword">delete</span> app.<span class="hljs-property">ui</span>[k];
<span id="line346" class="lineno">346</span>        }
<span id="line347" class="lineno">347</span>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> n <span class="hljs-keyword">in</span> app) {
<span id="line348" class="lineno">348</span>            <span class="hljs-keyword">delete</span> app[n];
<span id="line349" class="lineno">349</span>        }
<span id="line350" class="lineno">350</span>        <span class="hljs-title class_">MochiKit</span>.<span class="hljs-property">Signal</span>.<span class="hljs-title function_">disconnectAllTo</span>(app);
<span id="line351" class="lineno">351</span>        <span class="hljs-title function_">resolve</span>();
<span id="line352" class="lineno">352</span>    });
<span id="line353" class="lineno">353</span>};
<span id="line354" class="lineno">354</span>
<span id="line355" class="lineno">355</span><span class="hljs-comment">/**
<span id="line356" class="lineno">356</span> * Performs an asynchronous call to a method in an app. If only the class name
<span id="line357" class="lineno">357</span> * or launcher is specified, the most recently created instance will be used.
<span id="line358" class="lineno">358</span> * If no instance is running, one will be started. Also, before calling the app
<span id="line359" class="lineno">359</span> * method, the app UI will be focused.
<span id="line360" class="lineno">360</span> *
<span id="line361" class="lineno">361</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string|Object</span>} app the app id, instance, class name or launcher
<span id="line362" class="lineno">362</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} method the app method name
<span id="line363" class="lineno">363</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Mixed</span>} [args] additional parameters sent to method
<span id="line364" class="lineno">364</span> *
<span id="line365" class="lineno">365</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line366" class="lineno">366</span> *         resolve with the result of the call on success
<span id="line367" class="lineno">367</span> */</span>
<span id="line368" class="lineno">368</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">callApp</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">app, method</span>) {
<span id="line369" class="lineno">369</span>    <span class="hljs-keyword">const</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">arguments</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>);
<span id="line370" class="lineno">370</span>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-title class_">Async</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
<span id="line371" class="lineno">371</span>        <span class="hljs-keyword">const</span> launcher = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">findApp</span>(app);
<span id="line372" class="lineno">372</span>        <span class="hljs-keyword">if</span> (launcher == <span class="hljs-literal">null</span>) {
<span id="line373" class="lineno">373</span>            <span class="hljs-keyword">const</span> msg = <span class="hljs-string">&quot;No matching app launcher found&quot;</span>;
<span id="line374" class="lineno">374</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg, app);
<span id="line375" class="lineno">375</span>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>([msg, <span class="hljs-string">&quot;: &quot;</span>, app].<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>));
<span id="line376" class="lineno">376</span>        }
<span id="line377" class="lineno">377</span>        <span class="hljs-keyword">const</span> starter = launcher.<span class="hljs-property">instances</span>[<span class="hljs-number">0</span>] ?? launcher.<span class="hljs-property">starter</span> ?? <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">startApp</span>(app);
<span id="line378" class="lineno">378</span>        <span class="hljs-keyword">const</span> promise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(starter)
<span id="line379" class="lineno">379</span>            .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
<span id="line380" class="lineno">380</span>                <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">context</span>(<span class="hljs-string">`RapidContext.App.callApp(<span class="hljs-subst">${launcher.id}</span>,<span class="hljs-subst">${method}</span>)`</span>);
<span id="line381" class="lineno">381</span>                <span class="hljs-keyword">const</span> pos = launcher.<span class="hljs-property">instances</span>.<span class="hljs-title function_">indexOf</span>(app);
<span id="line382" class="lineno">382</span>                <span class="hljs-keyword">const</span> instance = (pos &gt;= <span class="hljs-number">0</span>) ? app : launcher.<span class="hljs-property">instances</span>[launcher.<span class="hljs-property">instances</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
<span id="line383" class="lineno">383</span>                <span class="hljs-keyword">const</span> child = instance.<span class="hljs-property">ui</span>.<span class="hljs-property">root</span>;
<span id="line384" class="lineno">384</span>                <span class="hljs-keyword">const</span> parent = child.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">&quot;.widget&quot;</span>);
<span id="line385" class="lineno">385</span>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(parent?.<span class="hljs-property">selectChild</span>) == <span class="hljs-string">&quot;function&quot;</span>) {
<span id="line386" class="lineno">386</span>                    parent.<span class="hljs-title function_">selectChild</span>(child);
<span id="line387" class="lineno">387</span>                }
<span id="line388" class="lineno">388</span>                <span class="hljs-keyword">const</span> methodName = <span class="hljs-string">`<span class="hljs-subst">${launcher.className}</span>.<span class="hljs-subst">${method}</span>`</span>;
<span id="line389" class="lineno">389</span>                <span class="hljs-keyword">if</span> (instance[method] == <span class="hljs-literal">null</span>) {
<span id="line390" class="lineno">390</span>                    <span class="hljs-keyword">const</span> msg = <span class="hljs-string">`No app method <span class="hljs-subst">${methodName}</span> found`</span>;
<span id="line391" class="lineno">391</span>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg);
<span id="line392" class="lineno">392</span>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(msg);
<span id="line393" class="lineno">393</span>                }
<span id="line394" class="lineno">394</span>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Calling app method <span class="hljs-subst">${methodName}</span>`</span>, args);
<span id="line395" class="lineno">395</span>                <span class="hljs-keyword">try</span> {
<span id="line396" class="lineno">396</span>                    <span class="hljs-keyword">return</span> instance[method](...args);
<span id="line397" class="lineno">397</span>                } <span class="hljs-keyword">catch</span> (e) {
<span id="line398" class="lineno">398</span>                    <span class="hljs-keyword">const</span> reason = <span class="hljs-string">`Caught error in <span class="hljs-subst">${methodName}</span>`</span>;
<span id="line399" class="lineno">399</span>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(reason, e);
<span id="line400" class="lineno">400</span>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${reason}</span>: <span class="hljs-subst">${e.toString()}</span>`</span>, { <span class="hljs-attr">cause</span>: e });
<span id="line401" class="lineno">401</span>                }
<span id="line402" class="lineno">402</span>            })
<span id="line403" class="lineno">403</span>            .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">context</span>(<span class="hljs-literal">null</span>));
<span id="line404" class="lineno">404</span>        <span class="hljs-title function_">resolve</span>(promise);
<span id="line405" class="lineno">405</span>    });
<span id="line406" class="lineno">406</span>};
<span id="line407" class="lineno">407</span>
<span id="line408" class="lineno">408</span><span class="hljs-comment">/**
<span id="line409" class="lineno">409</span> * Performs an asynchronous procedure call.
<span id="line410" class="lineno">410</span> *
<span id="line411" class="lineno">411</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} name the procedure name
<span id="line412" class="lineno">412</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array|Object</span>} [args] the arguments array, dictionary, or `null`
<span id="line413" class="lineno">413</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts] the procedure call options
<span id="line414" class="lineno">414</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} [opts.session] the HTTP session required flag
<span id="line415" class="lineno">415</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} [opts.trace] the procedure call trace flag
<span id="line416" class="lineno">416</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [opts.timeout] the timeout in milliseconds, default is 60s
<span id="line417" class="lineno">417</span> *
<span id="line418" class="lineno">418</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line419" class="lineno">419</span> *         resolve with the response data on success
<span id="line420" class="lineno">420</span> */</span>
<span id="line421" class="lineno">421</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">callProc</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">name, args, opts</span>) {
<span id="line422" class="lineno">422</span>    args = args ?? [];
<span id="line423" class="lineno">423</span>    opts = opts ?? {};
<span id="line424" class="lineno">424</span>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Call request <span class="hljs-subst">${name}</span>`</span>, args);
<span id="line425" class="lineno">425</span>    <span class="hljs-keyword">let</span> params = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Data</span>.<span class="hljs-title function_">map</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Encode</span>.<span class="hljs-property">toJSON</span>, args);
<span id="line426" class="lineno">426</span>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(params)) {
<span id="line427" class="lineno">427</span>        params = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Data</span>.<span class="hljs-title function_">object</span>(params.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">val, idx</span>) =&gt;</span> [<span class="hljs-string">`arg<span class="hljs-subst">${idx}</span>`</span>, val]));
<span id="line428" class="lineno">428</span>    }
<span id="line429" class="lineno">429</span>    params[<span class="hljs-string">&quot;system:session&quot;</span>] = !!opts.<span class="hljs-property">session</span>;
<span id="line430" class="lineno">430</span>    params[<span class="hljs-string">&quot;system:trace&quot;</span>] = !!opts.<span class="hljs-property">trace</span> || [<span class="hljs-string">&quot;all&quot;</span>, <span class="hljs-string">&quot;log&quot;</span>].<span class="hljs-title function_">includes</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Log</span>.<span class="hljs-title function_">level</span>());
<span id="line431" class="lineno">431</span>    params[<span class="hljs-string">&quot;system:token&quot;</span>] = opts.<span class="hljs-property">token</span>;
<span id="line432" class="lineno">432</span>    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`rapidcontext/procedure/<span class="hljs-subst">${name}</span>`</span>;
<span id="line433" class="lineno">433</span>    <span class="hljs-keyword">const</span> options = { <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-attr">timeout</span>: opts.<span class="hljs-property">timeout</span> ?? <span class="hljs-number">60000</span> };
<span id="line434" class="lineno">434</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadJSON</span>(url, params, options).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
<span id="line435" class="lineno">435</span>        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">trace</span>) {
<span id="line436" class="lineno">436</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> trace:`</span>, res.<span class="hljs-property">trace</span>);
<span id="line437" class="lineno">437</span>        }
<span id="line438" class="lineno">438</span>        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">error</span>) {
<span id="line439" class="lineno">439</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> error:`</span>, res.<span class="hljs-property">error</span>);
<span id="line440" class="lineno">440</span>            <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_Cache</span>.<span class="hljs-title function_">handleError</span>(res.<span class="hljs-property">error</span>);
<span id="line441" class="lineno">441</span>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(res.<span class="hljs-property">error</span>);
<span id="line442" class="lineno">442</span>        } <span class="hljs-keyword">else</span> {
<span id="line443" class="lineno">443</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> response:`</span>, res.<span class="hljs-property">data</span>);
<span id="line444" class="lineno">444</span>            <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;system/&quot;</span>)) {
<span id="line445" class="lineno">445</span>                <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_Cache</span>.<span class="hljs-title function_">update</span>(name, res.<span class="hljs-property">data</span>);
<span id="line446" class="lineno">446</span>            }
<span id="line447" class="lineno">447</span>            <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
<span id="line448" class="lineno">448</span>        }
<span id="line449" class="lineno">449</span>    });
<span id="line450" class="lineno">450</span>};
<span id="line451" class="lineno">451</span>
<span id="line452" class="lineno">452</span><span class="hljs-comment">/**
<span id="line453" class="lineno">453</span> * Performs an asynchronous login. If the current session is already bound to a
<span id="line454" class="lineno">454</span> * user, that session will be terminated and a new one will be created. If an
<span id="line455" class="lineno">455</span> * authentication token is specified, the login and password fields are not
<span id="line456" class="lineno">456</span> * used (can be null).
<span id="line457" class="lineno">457</span> *
<span id="line458" class="lineno">458</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} login the user login name or email address
<span id="line459" class="lineno">459</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} password the password to authenticate the user
<span id="line460" class="lineno">460</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [token] the authentication token to identify user/password
<span id="line461" class="lineno">461</span> *
<span id="line462" class="lineno">462</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that resolves when
<span id="line463" class="lineno">463</span> *         the authentication has either succeeded or failed
<span id="line464" class="lineno">464</span> */</span>
<span id="line465" class="lineno">465</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">login</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">login, password, token</span>) {
<span id="line466" class="lineno">466</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchLogin</span>(<span class="hljs-params"></span>) {
<span id="line467" class="lineno">467</span>        <span class="hljs-keyword">const</span> proc = <span class="hljs-string">&quot;system/user/search&quot;</span>;
<span id="line468" class="lineno">468</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(proc, [login]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
<span id="line469" class="lineno">469</span>            <span class="hljs-keyword">if</span> (user?.<span class="hljs-property">id</span>) {
<span id="line470" class="lineno">470</span>                <span class="hljs-keyword">return</span> login = user.<span class="hljs-property">id</span>;
<span id="line471" class="lineno">471</span>            } <span class="hljs-keyword">else</span> {
<span id="line472" class="lineno">472</span>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;no user with that email address&quot;</span>);
<span id="line473" class="lineno">473</span>            }
<span id="line474" class="lineno">474</span>        });
<span id="line475" class="lineno">475</span>    }
<span id="line476" class="lineno">476</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getNonce</span>(<span class="hljs-params"></span>) {
<span id="line477" class="lineno">477</span>        <span class="hljs-keyword">const</span> proc = <span class="hljs-string">&quot;system/session/current&quot;</span>;
<span id="line478" class="lineno">478</span>        <span class="hljs-keyword">const</span> opts = { <span class="hljs-attr">session</span>: <span class="hljs-literal">true</span> };
<span id="line479" class="lineno">479</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(proc, [], opts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">session</span>) =&gt;</span> session.<span class="hljs-property">nonce</span>);
<span id="line480" class="lineno">480</span>    }
<span id="line481" class="lineno">481</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">passwordAuth</span>(<span class="hljs-params">nonce</span>) {
<span id="line482" class="lineno">482</span>        <span class="hljs-keyword">const</span> realm = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">status</span>().<span class="hljs-property">realm</span>;
<span id="line483" class="lineno">483</span>        <span class="hljs-keyword">let</span> hash = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-title class_">MD5</span>(<span class="hljs-string">`<span class="hljs-subst">${login}</span>:<span class="hljs-subst">${realm}</span>:<span class="hljs-subst">${password}</span>`</span>);
<span id="line484" class="lineno">484</span>        hash = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-title class_">MD5</span>(<span class="hljs-string">`<span class="hljs-subst">${hash.toString()}</span>:<span class="hljs-subst">${nonce}</span>`</span>).<span class="hljs-title function_">toString</span>();
<span id="line485" class="lineno">485</span>        <span class="hljs-keyword">const</span> args = [login, nonce, hash];
<span id="line486" class="lineno">486</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/session/authenticate&quot;</span>, args);
<span id="line487" class="lineno">487</span>    }
<span id="line488" class="lineno">488</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">tokenAuth</span>(<span class="hljs-params"></span>) {
<span id="line489" class="lineno">489</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/session/authenticatetoken&quot;</span>, [token]);
<span id="line490" class="lineno">490</span>    }
<span id="line491" class="lineno">491</span>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">verifyAuth</span>(<span class="hljs-params">res</span>) {
<span id="line492" class="lineno">492</span>        <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">success</span> || res.<span class="hljs-property">error</span>) {
<span id="line493" class="lineno">493</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;login failed&quot;</span>, login, res.<span class="hljs-property">error</span>);
<span id="line494" class="lineno">494</span>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(res.<span class="hljs-property">error</span> ?? <span class="hljs-string">&quot;authentication failed&quot;</span>);
<span id="line495" class="lineno">495</span>        }
<span id="line496" class="lineno">496</span>    }
<span id="line497" class="lineno">497</span>    <span class="hljs-keyword">let</span> promise = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-number">0</span>);
<span id="line498" class="lineno">498</span>    <span class="hljs-keyword">const</span> user = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">user</span>();
<span id="line499" class="lineno">499</span>    <span class="hljs-keyword">if</span> (user?.<span class="hljs-property">id</span>) {
<span id="line500" class="lineno">500</span>        promise = promise.<span class="hljs-title function_">then</span>(<span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">logout</span>);
<span id="line501" class="lineno">501</span>    }
<span id="line502" class="lineno">502</span>    <span class="hljs-keyword">if</span> (token) {
<span id="line503" class="lineno">503</span>        <span class="hljs-keyword">return</span> promise.<span class="hljs-title function_">then</span>(tokenAuth).<span class="hljs-title function_">then</span>(verifyAuth);
<span id="line504" class="lineno">504</span>    } <span class="hljs-keyword">else</span> {
<span id="line505" class="lineno">505</span>        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/@/</span>.<span class="hljs-title function_">test</span>(login)) {
<span id="line506" class="lineno">506</span>            promise = promise.<span class="hljs-title function_">then</span>(searchLogin);
<span id="line507" class="lineno">507</span>        }
<span id="line508" class="lineno">508</span>        <span class="hljs-keyword">return</span> promise.<span class="hljs-title function_">then</span>(getNonce).<span class="hljs-title function_">then</span>(passwordAuth).<span class="hljs-title function_">then</span>(verifyAuth);
<span id="line509" class="lineno">509</span>    }
<span id="line510" class="lineno">510</span>};
<span id="line511" class="lineno">511</span>
<span id="line512" class="lineno">512</span><span class="hljs-comment">/**
<span id="line513" class="lineno">513</span> * Performs an asynchronous logout. This function terminates the current
<span id="line514" class="lineno">514</span> * session and either reloads the browser window or returns a deferred object
<span id="line515" class="lineno">515</span> * that will produce either a `callback` or an `errback` response.
<span id="line516" class="lineno">516</span> *
<span id="line517" class="lineno">517</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} [reload=true] the reload browser flag
<span id="line518" class="lineno">518</span> *
<span id="line519" class="lineno">519</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line520" class="lineno">520</span> *         resolve when user is logged out
<span id="line521" class="lineno">521</span> */</span>
<span id="line522" class="lineno">522</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">logout</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">reload</span>) {
<span id="line523" class="lineno">523</span>    <span class="hljs-keyword">const</span> promise = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/session/terminate&quot;</span>, [<span class="hljs-literal">null</span>]);
<span id="line524" class="lineno">524</span>    <span class="hljs-keyword">if</span> (reload !== <span class="hljs-literal">false</span>) {
<span id="line525" class="lineno">525</span>        promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>());
<span id="line526" class="lineno">526</span>    }
<span id="line527" class="lineno">527</span>    <span class="hljs-keyword">return</span> promise;
<span id="line528" class="lineno">528</span>};
<span id="line529" class="lineno">529</span>
<span id="line530" class="lineno">530</span><span class="hljs-comment">/**
<span id="line531" class="lineno">531</span> * Performs an asynchronous HTTP request and parses the JSON response. The
<span id="line532" class="lineno">532</span> * request parameters are automatically encoded to query string or JSON format,
<span id="line533" class="lineno">533</span> * depending on the `Content-Type` header. The parameters will be sent either
<span id="line534" class="lineno">534</span> * in the URL or as the request payload (depending on the HTTP `method`).
<span id="line535" class="lineno">535</span> *
<span id="line536" class="lineno">536</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL to request
<span id="line537" class="lineno">537</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [params] the request parameters, or `null`
<span id="line538" class="lineno">538</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts] the request options, or `null`
<span id="line539" class="lineno">539</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [opts.method] the HTTP method, default is `GET`
<span id="line540" class="lineno">540</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [opts.timeout] the timeout in milliseconds, default is 30s
<span id="line541" class="lineno">541</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts.headers] the specific HTTP headers to use
<span id="line542" class="lineno">542</span> *
<span id="line543" class="lineno">543</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line544" class="lineno">544</span> *         resolve with the parsed response JSON on success
<span id="line545" class="lineno">545</span> */</span>
<span id="line546" class="lineno">546</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadJSON</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url, params, opts</span>) {
<span id="line547" class="lineno">547</span>    opts = { <span class="hljs-attr">responseType</span>: <span class="hljs-string">&quot;json&quot;</span>, ...opts };
<span id="line548" class="lineno">548</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadXHR</span>(url, params, opts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">xhr</span>) =&gt;</span> xhr.<span class="hljs-property">response</span>);
<span id="line549" class="lineno">549</span>};
<span id="line550" class="lineno">550</span>
<span id="line551" class="lineno">551</span><span class="hljs-comment">/**
<span id="line552" class="lineno">552</span> * Performs an asynchronous HTTP request for a text document. The request
<span id="line553" class="lineno">553</span> * parameters are automatically encoded to query string or JSON format,
<span id="line554" class="lineno">554</span> * depending on the `Content-Type` header. The parameters will be sent either
<span id="line555" class="lineno">555</span> * in the URL or as the request payload (depending on the HTTP `method`).
<span id="line556" class="lineno">556</span> *
<span id="line557" class="lineno">557</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL to request
<span id="line558" class="lineno">558</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [params] the request parameters, or `null`
<span id="line559" class="lineno">559</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts] the request options, or `null`
<span id="line560" class="lineno">560</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [opts.method] the HTTP method, &quot;GET&quot; or &quot;POST&quot;
<span id="line561" class="lineno">561</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [opts.timeout] the timeout in milliseconds, default is 30s
<span id="line562" class="lineno">562</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts.headers] the specific HTTP headers to use
<span id="line563" class="lineno">563</span> *
<span id="line564" class="lineno">564</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line565" class="lineno">565</span> *         resolve with the response text on success
<span id="line566" class="lineno">566</span> */</span>
<span id="line567" class="lineno">567</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url, params, opts</span>) {
<span id="line568" class="lineno">568</span>    opts = { <span class="hljs-attr">responseType</span>: <span class="hljs-string">&quot;text&quot;</span>, ...opts };
<span id="line569" class="lineno">569</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadXHR</span>(url, params, opts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">xhr</span>) =&gt;</span> xhr.<span class="hljs-property">response</span>);
<span id="line570" class="lineno">570</span>};
<span id="line571" class="lineno">571</span>
<span id="line572" class="lineno">572</span><span class="hljs-comment">/**
<span id="line573" class="lineno">573</span> * Performs an asynchronous HTTP request for an XML document. The request
<span id="line574" class="lineno">574</span> * parameters are automatically encoded to query string or JSON format,
<span id="line575" class="lineno">575</span> * depending on the `Content-Type` header. The parameters will be sent either
<span id="line576" class="lineno">576</span> * in the URL or as the request payload (depending on the HTTP `method`).
<span id="line577" class="lineno">577</span> *
<span id="line578" class="lineno">578</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL to request
<span id="line579" class="lineno">579</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [params] the request parameters, or `null`
<span id="line580" class="lineno">580</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts] the request options, or `null`
<span id="line581" class="lineno">581</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [opts.method] the HTTP method, &quot;GET&quot; or &quot;POST&quot;
<span id="line582" class="lineno">582</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [opts.timeout] the timeout in milliseconds, default is 30s
<span id="line583" class="lineno">583</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts.headers] the specific HTTP headers to use
<span id="line584" class="lineno">584</span> *
<span id="line585" class="lineno">585</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line586" class="lineno">586</span> *         resolve with the parsed response XML document on success
<span id="line587" class="lineno">587</span> */</span>
<span id="line588" class="lineno">588</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadXML</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url, params, opts</span>) {
<span id="line589" class="lineno">589</span>    opts = { <span class="hljs-attr">responseType</span>: <span class="hljs-string">&quot;document&quot;</span>, ...opts };
<span id="line590" class="lineno">590</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">loadXHR</span>(url, params, opts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">xhr</span>) =&gt;</span> xhr.<span class="hljs-property">response</span>);
<span id="line591" class="lineno">591</span>};
<span id="line592" class="lineno">592</span>
<span id="line593" class="lineno">593</span><span class="hljs-comment">/**
<span id="line594" class="lineno">594</span> * Performs an asynchronous HTTP request. The request parameters are
<span id="line595" class="lineno">595</span> * automatically encoded to query string or JSON format, depending on the
<span id="line596" class="lineno">596</span> * `Content-Type` header. The parameters will be sent either in the URL or as
<span id="line597" class="lineno">597</span> * the request payload (depending on the HTTP `method`).
<span id="line598" class="lineno">598</span> *
<span id="line599" class="lineno">599</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL to request
<span id="line600" class="lineno">600</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [params] the request parameters, or `null`
<span id="line601" class="lineno">601</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts] the request options, or `null`
<span id="line602" class="lineno">602</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [opts.method] the HTTP method, default is `GET`
<span id="line603" class="lineno">603</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [opts.timeout] the timeout in milliseconds, default is 30s
<span id="line604" class="lineno">604</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [opts.headers] the specific HTTP headers to use
<span id="line605" class="lineno">605</span> *
<span id="line606" class="lineno">606</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line607" class="lineno">607</span> *         resolve with the XMLHttpRequest instance on success
<span id="line608" class="lineno">608</span> */</span>
<span id="line609" class="lineno">609</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadXHR</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url, params, opts</span>) {
<span id="line610" class="lineno">610</span>    opts = { <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-attr">headers</span>: {}, <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>, ...opts };
<span id="line611" class="lineno">611</span>    opts.<span class="hljs-property">timeout</span> = (opts.<span class="hljs-property">timeout</span> &lt; <span class="hljs-number">1000</span>) ? opts.<span class="hljs-property">timeout</span> * <span class="hljs-number">1000</span> : opts.<span class="hljs-property">timeout</span>;
<span id="line612" class="lineno">612</span>    <span class="hljs-keyword">const</span> hasBody = params &amp;&amp; [<span class="hljs-string">&quot;PATCH&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;PUT&quot;</span>].<span class="hljs-title function_">includes</span>(opts.<span class="hljs-property">method</span>);
<span id="line613" class="lineno">613</span>    <span class="hljs-keyword">const</span> hasJsonBody = opts.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;Content-Type&quot;</span>] === <span class="hljs-string">&quot;application/json&quot;</span>;
<span id="line614" class="lineno">614</span>    <span class="hljs-keyword">if</span> (!hasBody) {
<span id="line615" class="lineno">615</span>        <span class="hljs-keyword">const</span> op = url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;?&quot;</span>) ? <span class="hljs-string">&quot;&amp;&quot;</span> : <span class="hljs-string">&quot;?&quot;</span>;
<span id="line616" class="lineno">616</span>        url += params ? <span class="hljs-string">`<span class="hljs-subst">${op}</span><span class="hljs-subst">${RapidContext.Encode.toUrlQuery(params)}</span>`</span> : <span class="hljs-string">&quot;&quot;</span>;
<span id="line617" class="lineno">617</span>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (params &amp;&amp; hasBody &amp;&amp; hasJsonBody) {
<span id="line618" class="lineno">618</span>        opts.<span class="hljs-property">body</span> = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Encode</span>.<span class="hljs-title function_">toJSON</span>(params);
<span id="line619" class="lineno">619</span>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (params &amp;&amp; hasBody) {
<span id="line620" class="lineno">620</span>        opts.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;Content-Type&quot;</span>] = <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>;
<span id="line621" class="lineno">621</span>        opts.<span class="hljs-property">body</span> = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Encode</span>.<span class="hljs-title function_">toUrlQuery</span>(params);
<span id="line622" class="lineno">622</span>    }
<span id="line623" class="lineno">623</span>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Starting XHR loading&quot;</span>, url, opts);
<span id="line624" class="lineno">624</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">xhr</span>(url, opts).<span class="hljs-title function_">then</span>(
<span id="line625" class="lineno">625</span>        <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
<span id="line626" class="lineno">626</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Completed XHR loading&quot;</span>, url);
<span id="line627" class="lineno">627</span>            <span class="hljs-keyword">return</span> res;
<span id="line628" class="lineno">628</span>        },
<span id="line629" class="lineno">629</span>        <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
<span id="line630" class="lineno">630</span>            <span class="hljs-keyword">const</span> logger = <span class="hljs-regexp">/timeout/i</span>.<span class="hljs-title function_">test</span>(err) ? <span class="hljs-variable language_">console</span>.<span class="hljs-property">info</span> : <span class="hljs-variable language_">console</span>.<span class="hljs-property">warn</span>;
<span id="line631" class="lineno">631</span>            <span class="hljs-title function_">logger</span>(<span class="hljs-string">&quot;Failed XHR loading&quot;</span>, url, err);
<span id="line632" class="lineno">632</span>            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
<span id="line633" class="lineno">633</span>        }
<span id="line634" class="lineno">634</span>    );
<span id="line635" class="lineno">635</span>};
<span id="line636" class="lineno">636</span>
<span id="line637" class="lineno">637</span><span class="hljs-comment">/**
<span id="line638" class="lineno">638</span> * Loads a JavaScript to the current page. The script is loaded by
<span id="line639" class="lineno">639</span> * inserting a `&lt;script&gt;` tag in the document `&lt;head&gt;`. Function definitions
<span id="line640" class="lineno">640</span> * and values must therefore be stored to global variables by the script to
<span id="line641" class="lineno">641</span> * become accessible after loading. If the script is already loaded, the
<span id="line642" class="lineno">642</span> * promise will resolve immediately.
<span id="line643" class="lineno">643</span> *
<span id="line644" class="lineno">644</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL to the script
<span id="line645" class="lineno">645</span> *
<span id="line646" class="lineno">646</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line647" class="lineno">647</span> *         resolve when the script has loaded
<span id="line648" class="lineno">648</span> *
<span id="line649" class="lineno">649</span> * <span class="hljs-doctag">@see</span> Use dynamic `import()` instead, if supported by the environment.
<span id="line650" class="lineno">650</span> */</span>
<span id="line651" class="lineno">651</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadScript</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url</span>) {
<span id="line652" class="lineno">652</span>    <span class="hljs-keyword">const</span> selector = [<span class="hljs-string">&quot;script[src*=&#x27;&quot;</span>, url, <span class="hljs-string">&quot;&#x27;]&quot;</span>].<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>);
<span id="line653" class="lineno">653</span>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(selector).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
<span id="line654" class="lineno">654</span>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;script already loaded, skipping&quot;</span>, url);
<span id="line655" class="lineno">655</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-number">0</span>);
<span id="line656" class="lineno">656</span>    } <span class="hljs-keyword">else</span> {
<span id="line657" class="lineno">657</span>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;loading script&quot;</span>, url);
<span id="line658" class="lineno">658</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">script</span>(url);
<span id="line659" class="lineno">659</span>    }
<span id="line660" class="lineno">660</span>};
<span id="line661" class="lineno">661</span>
<span id="line662" class="lineno">662</span><span class="hljs-comment">/**
<span id="line663" class="lineno">663</span> * Loads a CSS stylesheet to the current page asynchronously. The
<span id="line664" class="lineno">664</span> * stylesheet is loaded by inserting a `&lt;link&gt;` tag in the document `head`.
<span id="line665" class="lineno">665</span> * If the stylesheet is already loaded, the promise will resolve immediately.
<span id="line666" class="lineno">666</span> *
<span id="line667" class="lineno">667</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL to the stylesheet
<span id="line668" class="lineno">668</span> *
<span id="line669" class="lineno">669</span> * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise</span>} a `RapidContext.Async` promise that will
<span id="line670" class="lineno">670</span> *         callback when the stylesheet has been loaded
<span id="line671" class="lineno">671</span> */</span>
<span id="line672" class="lineno">672</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">loadStyles</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url</span>) {
<span id="line673" class="lineno">673</span>    <span class="hljs-keyword">const</span> selector = [<span class="hljs-string">&quot;link[href*=&#x27;&quot;</span>, url, <span class="hljs-string">&quot;&#x27;]&quot;</span>].<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>);
<span id="line674" class="lineno">674</span>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(selector).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
<span id="line675" class="lineno">675</span>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;stylesheet already loaded, skipping&quot;</span>, url);
<span id="line676" class="lineno">676</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-number">0</span>);
<span id="line677" class="lineno">677</span>    } <span class="hljs-keyword">else</span> {
<span id="line678" class="lineno">678</span>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;loading stylesheet&quot;</span>, url);
<span id="line679" class="lineno">679</span>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">css</span>(url);
<span id="line680" class="lineno">680</span>    }
<span id="line681" class="lineno">681</span>};
<span id="line682" class="lineno">682</span>
<span id="line683" class="lineno">683</span><span class="hljs-comment">/**
<span id="line684" class="lineno">684</span> * Downloads a file to the user desktop. This works by creating a new
<span id="line685" class="lineno">685</span> * window or an inner frame which downloads the file from the server.
<span id="line686" class="lineno">686</span> * Due to `Content-Disposition` headers being set on the server, the
<span id="line687" class="lineno">687</span> * web browser will popup a dialog for the user to save the file.
<span id="line688" class="lineno">688</span> * This function can also be used for saving a file that doesn&#x27;t
<span id="line689" class="lineno">689</span> * exist by first posting the file (text) content to the server.
<span id="line690" class="lineno">690</span> *
<span id="line691" class="lineno">691</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} url the URL or filename to download
<span id="line692" class="lineno">692</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [data] the optional file data (if not available
<span id="line693" class="lineno">693</span> *            on the server-side)
<span id="line694" class="lineno">694</span> */</span>
<span id="line695" class="lineno">695</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">downloadFile</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url, data</span>) {
<span id="line696" class="lineno">696</span>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
<span id="line697" class="lineno">697</span>        <span class="hljs-keyword">const</span> op = url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;?&quot;</span>) ? <span class="hljs-string">&quot;&amp;&quot;</span> : <span class="hljs-string">&quot;?&quot;</span>;
<span id="line698" class="lineno">698</span>        url += <span class="hljs-string">`<span class="hljs-subst">${op}</span>download`</span>;
<span id="line699" class="lineno">699</span>        <span class="hljs-keyword">const</span> attrs = {
<span id="line700" class="lineno">700</span>            <span class="hljs-attr">src</span>: url,
<span id="line701" class="lineno">701</span>            <span class="hljs-attr">border</span>: <span class="hljs-string">&quot;0&quot;</span>,
<span id="line702" class="lineno">702</span>            <span class="hljs-attr">frameborder</span>: <span class="hljs-string">&quot;0&quot;</span>,
<span id="line703" class="lineno">703</span>            <span class="hljs-attr">height</span>: <span class="hljs-string">&quot;0&quot;</span>,
<span id="line704" class="lineno">704</span>            <span class="hljs-attr">width</span>: <span class="hljs-string">&quot;0&quot;</span>
<span id="line705" class="lineno">705</span>        };
<span id="line706" class="lineno">706</span>        <span class="hljs-keyword">const</span> iframe = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">&quot;iframe&quot;</span>, attrs);
<span id="line707" class="lineno">707</span>        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">append</span>(iframe);
<span id="line708" class="lineno">708</span>    } <span class="hljs-keyword">else</span> {
<span id="line709" class="lineno">709</span>        <span class="hljs-keyword">const</span> name = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">INPUT</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;fileName&quot;</span>, <span class="hljs-attr">value</span>: url });
<span id="line710" class="lineno">710</span>        <span class="hljs-keyword">const</span> file = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">INPUT</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;fileData&quot;</span>, <span class="hljs-attr">value</span>: data });
<span id="line711" class="lineno">711</span>        <span class="hljs-keyword">const</span> flag = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">INPUT</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;download&quot;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&quot;1&quot;</span> });
<span id="line712" class="lineno">712</span>        <span class="hljs-keyword">const</span> attrs = {
<span id="line713" class="lineno">713</span>            <span class="hljs-attr">action</span>: <span class="hljs-string">&quot;rapidcontext/download&quot;</span>,
<span id="line714" class="lineno">714</span>            <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,
<span id="line715" class="lineno">715</span>            <span class="hljs-attr">target</span>: <span class="hljs-string">&quot;_blank&quot;</span>,
<span id="line716" class="lineno">716</span>            <span class="hljs-attr">style</span>: { <span class="hljs-attr">display</span>: <span class="hljs-string">&quot;none&quot;</span> }
<span id="line717" class="lineno">717</span>        };
<span id="line718" class="lineno">718</span>        <span class="hljs-keyword">const</span> form = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-title function_">FORM</span>(attrs, name, file, flag);
<span id="line719" class="lineno">719</span>        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">append</span>(form);
<span id="line720" class="lineno">720</span>        form.<span class="hljs-title function_">submit</span>();
<span id="line721" class="lineno">721</span>    }
<span id="line722" class="lineno">722</span>};
<span id="line723" class="lineno">723</span>
<span id="line724" class="lineno">724</span><span class="hljs-comment">/**
<span id="line725" class="lineno">725</span> * Uploads a file to the server. The upload is handled by an
<span id="line726" class="lineno">726</span> * asynchronous HTTP request.
<span id="line727" class="lineno">727</span> *
<span id="line728" class="lineno">728</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} id the upload identifier to use
<span id="line729" class="lineno">729</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} file the file object to upload
<span id="line730" class="lineno">730</span> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">function</span>} [onProgress] the progress event handler
<span id="line731" class="lineno">731</span> */</span>
<span id="line732" class="lineno">732</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">uploadFile</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">id, file, onProgress</span>) {
<span id="line733" class="lineno">733</span>    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
<span id="line734" class="lineno">734</span>    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&quot;file&quot;</span>, file);
<span id="line735" class="lineno">735</span>    <span class="hljs-keyword">const</span> opts = {
<span id="line736" class="lineno">736</span>        <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,
<span id="line737" class="lineno">737</span>        <span class="hljs-attr">body</span>: formData,
<span id="line738" class="lineno">738</span>        <span class="hljs-attr">timeout</span>: <span class="hljs-number">300000</span>,
<span id="line739" class="lineno">739</span>        <span class="hljs-attr">progress</span>: onProgress,
<span id="line740" class="lineno">740</span>        <span class="hljs-attr">log</span>: <span class="hljs-string">`<span class="hljs-subst">${id}</span> upload`</span>
<span id="line741" class="lineno">741</span>    };
<span id="line742" class="lineno">742</span>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Async</span>.<span class="hljs-title function_">xhr</span>(<span class="hljs-string">`rapidcontext/upload/<span class="hljs-subst">${id}</span>`</span>, opts);
<span id="line743" class="lineno">743</span>};
<span id="line744" class="lineno">744</span>
<span id="line745" class="lineno">745</span><span class="hljs-comment">/**
<span id="line746" class="lineno">746</span> * The application data cache. Contains the most recently retrieved
<span id="line747" class="lineno">747</span> * data for some commonly used objects in the execution environment.
<span id="line748" class="lineno">748</span> */</span>
<span id="line749" class="lineno">749</span><span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">_Cache</span> = {
<span id="line750" class="lineno">750</span>    <span class="hljs-attr">version</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>),
<span id="line751" class="lineno">751</span>    <span class="hljs-attr">status</span>: <span class="hljs-literal">null</span>,
<span id="line752" class="lineno">752</span>    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
<span id="line753" class="lineno">753</span>    <span class="hljs-attr">apps</span>: {},
<span id="line754" class="lineno">754</span>
<span id="line755" class="lineno">755</span>    <span class="hljs-comment">// Normalizes an app manifest and its resources</span>
<span id="line756" class="lineno">756</span>    <span class="hljs-title function_">_normalizeApp</span>(<span class="hljs-params">app</span>) {
<span id="line757" class="lineno">757</span>        <span class="hljs-keyword">function</span> <span class="hljs-title function_">toType</span>(<span class="hljs-params">type, url</span>) {
<span id="line758" class="lineno">758</span>            <span class="hljs-keyword">const</span> isJs = !type &amp;&amp; <span class="hljs-regexp">/\.js$/i</span>.<span class="hljs-title function_">test</span>(url);
<span id="line759" class="lineno">759</span>            <span class="hljs-keyword">const</span> isCss = !type &amp;&amp; <span class="hljs-regexp">/\.css$/i</span>.<span class="hljs-title function_">test</span>(url);
<span id="line760" class="lineno">760</span>            <span class="hljs-keyword">if</span> ([<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;js&quot;</span>, <span class="hljs-string">&quot;javascript&quot;</span>].<span class="hljs-title function_">includes</span>(type) || isJs) {
<span id="line761" class="lineno">761</span>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;code&quot;</span>;
<span id="line762" class="lineno">762</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!type &amp;&amp; <span class="hljs-regexp">/\.mjs$/i</span>.<span class="hljs-title function_">test</span>(url)) {
<span id="line763" class="lineno">763</span>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;module&quot;</span>;
<span id="line764" class="lineno">764</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">&quot;style&quot;</span>, <span class="hljs-string">&quot;css&quot;</span>].<span class="hljs-title function_">includes</span>(type) || isCss) {
<span id="line765" class="lineno">765</span>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;style&quot;</span>;
<span id="line766" class="lineno">766</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!type &amp;&amp; <span class="hljs-regexp">/\.json$/i</span>.<span class="hljs-title function_">test</span>(url)) {
<span id="line767" class="lineno">767</span>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;json&quot;</span>;
<span id="line768" class="lineno">768</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!type &amp;&amp; <span class="hljs-regexp">/ui\.xml$/i</span>.<span class="hljs-title function_">test</span>(url)) {
<span id="line769" class="lineno">769</span>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ui&quot;</span>;
<span id="line770" class="lineno">770</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!type &amp;&amp; !app.<span class="hljs-property">icon</span> &amp;&amp; <span class="hljs-regexp">/\.(gif|jpg|jpeg|png|svg)$/i</span>.<span class="hljs-title function_">test</span>(url)) {
<span id="line771" class="lineno">771</span>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;icon&quot;</span>;
<span id="line772" class="lineno">772</span>            } <span class="hljs-keyword">else</span> {
<span id="line773" class="lineno">773</span>                <span class="hljs-keyword">return</span> type;
<span id="line774" class="lineno">774</span>            }
<span id="line775" class="lineno">775</span>        }
<span id="line776" class="lineno">776</span>        <span class="hljs-keyword">function</span> <span class="hljs-title function_">toIcon</span>(<span class="hljs-params">res</span>) {
<span id="line777" class="lineno">777</span>            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">url</span>) {
<span id="line778" class="lineno">778</span>                <span class="hljs-keyword">return</span> $(<span class="hljs-string">&quot;&lt;img/&gt;&quot;</span>).<span class="hljs-title function_">attr</span>({ <span class="hljs-attr">src</span>: res.<span class="hljs-property">url</span> }).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&quot;-app-icon&quot;</span>).<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>);
<span id="line779" class="lineno">779</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res.<span class="hljs-property">html</span>) {
<span id="line780" class="lineno">780</span>                <span class="hljs-keyword">const</span> node = $(<span class="hljs-string">&quot;&lt;span/&gt;&quot;</span>).<span class="hljs-title function_">html</span>(res.<span class="hljs-property">html</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&quot;-app-icon&quot;</span>).<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>);
<span id="line781" class="lineno">781</span>                <span class="hljs-keyword">return</span> node.<span class="hljs-property">childNodes</span>.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> ? node.<span class="hljs-property">childNodes</span>[<span class="hljs-number">0</span>] : node;
<span id="line782" class="lineno">782</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res[<span class="hljs-string">&quot;class&quot;</span>]) {
<span id="line783" class="lineno">783</span>                <span class="hljs-keyword">return</span> $(<span class="hljs-string">&quot;&lt;i/&gt;&quot;</span>).<span class="hljs-title function_">addClass</span>(res[<span class="hljs-string">&quot;class&quot;</span>]).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&quot;-app-icon&quot;</span>).<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>);
<span id="line784" class="lineno">784</span>            } <span class="hljs-keyword">else</span> {
<span id="line785" class="lineno">785</span>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span id="line786" class="lineno">786</span>            }
<span id="line787" class="lineno">787</span>        }
<span id="line788" class="lineno">788</span>        <span class="hljs-keyword">function</span> <span class="hljs-title function_">toResource</span>(<span class="hljs-params">res</span>) {
<span id="line789" class="lineno">789</span>            res = (<span class="hljs-title function_">typeof</span>(res) === <span class="hljs-string">&quot;string&quot;</span>) ? { <span class="hljs-attr">url</span>: res } : res;
<span id="line790" class="lineno">790</span>            res.<span class="hljs-property">type</span> = <span class="hljs-title function_">toType</span>(res.<span class="hljs-property">type</span>, res.<span class="hljs-property">url</span>);
<span id="line791" class="lineno">791</span>            <span class="hljs-keyword">if</span> (!app.<span class="hljs-property">icon</span> &amp;&amp; res.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;icon&quot;</span>) {
<span id="line792" class="lineno">792</span>                app.<span class="hljs-property">icon</span> = <span class="hljs-title function_">toIcon</span>(res);
<span id="line793" class="lineno">793</span>            }
<span id="line794" class="lineno">794</span>            <span class="hljs-keyword">return</span> res;
<span id="line795" class="lineno">795</span>        }
<span id="line796" class="lineno">796</span>        app = { ...app };
<span id="line797" class="lineno">797</span>        app.<span class="hljs-property">launch</span> = app.<span class="hljs-property">launch</span> ?? <span class="hljs-string">&quot;manual&quot;</span>;
<span id="line798" class="lineno">798</span>        app.<span class="hljs-property">resources</span> = [].<span class="hljs-title function_">concat</span>(app.<span class="hljs-property">resources</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>).<span class="hljs-title function_">map</span>(toResource);
<span id="line799" class="lineno">799</span>        <span class="hljs-keyword">if</span> (!app.<span class="hljs-property">icon</span>) {
<span id="line800" class="lineno">800</span>            app.<span class="hljs-property">icon</span> = <span class="hljs-title function_">toIcon</span>({ <span class="hljs-string">&quot;class&quot;</span>: <span class="hljs-string">&quot;fa fa-4x fa-question-circle unimportant&quot;</span> });
<span id="line801" class="lineno">801</span>        }
<span id="line802" class="lineno">802</span>        <span class="hljs-keyword">return</span> app;
<span id="line803" class="lineno">803</span>    },
<span id="line804" class="lineno">804</span>
<span id="line805" class="lineno">805</span>    <span class="hljs-comment">// Updates the cache data with the procedure results.</span>
<span id="line806" class="lineno">806</span>    <span class="hljs-title function_">update</span>(<span class="hljs-params">proc, data</span>) {
<span id="line807" class="lineno">807</span>        <span class="hljs-keyword">switch</span> (proc) {
<span id="line808" class="lineno">808</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;system/status&quot;</span>:
<span id="line809" class="lineno">809</span>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = { ...data };
<span id="line810" class="lineno">810</span>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Updated cached status&quot;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span>);
<span id="line811" class="lineno">811</span>            <span class="hljs-keyword">break</span>;
<span id="line812" class="lineno">812</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;system/session/current&quot;</span>:
<span id="line813" class="lineno">813</span>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> !== data?.<span class="hljs-property">user</span>?.<span class="hljs-property">id</span>) {
<span id="line814" class="lineno">814</span>                <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">UI</span>.<span class="hljs-property">Msg</span>.<span class="hljs-property">error</span>.<span class="hljs-title function_">loggedOut</span>();
<span id="line815" class="lineno">815</span>                <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-property">callProc</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;logged out&quot;</span>));
<span id="line816" class="lineno">816</span>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> &amp;&amp; data?.<span class="hljs-property">user</span>) {
<span id="line817" class="lineno">817</span>                <span class="hljs-keyword">const</span> o = <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">Data</span>.<span class="hljs-title function_">clone</span>(data.<span class="hljs-property">user</span>);
<span id="line818" class="lineno">818</span>                o.<span class="hljs-property">longName</span> = o.<span class="hljs-property">name</span> ? <span class="hljs-string">`<span class="hljs-subst">${o.name}</span> (<span class="hljs-subst">${o.id}</span>)`</span> : o.<span class="hljs-property">id</span>;
<span id="line819" class="lineno">819</span>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Updated cached user&quot;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>);
<span id="line820" class="lineno">820</span>            }
<span id="line821" class="lineno">821</span>            <span class="hljs-keyword">break</span>;
<span id="line822" class="lineno">822</span>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;system/app/list&quot;</span>:
<span id="line823" class="lineno">823</span>            <span class="hljs-keyword">if</span> (data) {
<span id="line824" class="lineno">824</span>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> o <span class="hljs-keyword">of</span> data) {
<span id="line825" class="lineno">825</span>                    <span class="hljs-keyword">const</span> launcher = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_normalizeApp</span>(o);
<span id="line826" class="lineno">826</span>                    launcher.<span class="hljs-property">instances</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">apps</span>[launcher.<span class="hljs-property">id</span>]?.<span class="hljs-property">instances</span> ?? [];
<span id="line827" class="lineno">827</span>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">apps</span>[launcher.<span class="hljs-property">id</span>] = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">apps</span>[launcher.<span class="hljs-property">id</span>] ?? {}, launcher);
<span id="line828" class="lineno">828</span>                }
<span id="line829" class="lineno">829</span>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Updated cached apps&quot;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">apps</span>);
<span id="line830" class="lineno">830</span>            }
<span id="line831" class="lineno">831</span>            <span class="hljs-keyword">break</span>;
<span id="line832" class="lineno">832</span>        }
<span id="line833" class="lineno">833</span>    },
<span id="line834" class="lineno">834</span>
<span id="line835" class="lineno">835</span>    <span class="hljs-comment">// Updates the cache data on some procedure errors.</span>
<span id="line836" class="lineno">836</span>    <span class="hljs-title function_">handleError</span>(<span class="hljs-params">error</span>) {
<span id="line837" class="lineno">837</span>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> &amp;&amp; <span class="hljs-regexp">/permission denied/i</span>.<span class="hljs-title function_">test</span>(error)) {
<span id="line838" class="lineno">838</span>            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RapidContext</span>.<span class="hljs-property">App</span>.<span class="hljs-title function_">callProc</span>(<span class="hljs-string">&quot;system/session/current&quot;</span>));
<span id="line839" class="lineno">839</span>        }
<span id="line840" class="lineno">840</span>    }
<span id="line841" class="lineno">841</span>};
<span id="line842" class="lineno">842</span></code></pre>
        </article>
    </section>





      </div>
    </section>

    <section class="footer center fineprint">
      <hr>
      Copyright &copy; 2007-2026 Per Cederberg. All rights reserved.
    </section>

  </body>
</html>
